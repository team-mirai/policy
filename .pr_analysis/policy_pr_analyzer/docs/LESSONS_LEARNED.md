# Policy PR Analyzer - 課題と改善計画

## 📋 概要

チームみらい政党のマニフェストリポジトリにおけるPR分析システムの課題と改善計画。749件の教育政策PR分析を通じて判明した技術的課題、スケール問題、および解決策をまとめます。

## 🚨 処理対象の規模とボトルネック

### PR蓄積の深刻な状況
- **現在のオープンPR数**: 6000件超（2025年7月16日時点）
- **最古のPR**: 2025年5月16日から放置（約2ヶ月）
- **日次処理比率**: 作成747件 vs クローズ15件（2025-07-14〜15の実績）
- **処理率**: わずか2%（98%が蓄積）

### 政策分野別の内訳（推定）
- **教育**: 749件（確認済み）
- **医療・福祉**: 推定800-1000件
- **経済・税制**: 推定600-800件
- **デジタル**: 推定400-600件
- **その他分野**: 推定2500-3000件

### スケールの問題
- **人手レビューのボトルネック**: 現在の処理速度では永続的に蓄積
- **継続的な増加**: 毎日数百件のPRが新規作成
- **緊急性**: 政策決定への影響、有権者への応答遅延

## 🔍 判明した課題

### 1. レート制限問題
- **現象**: 5並列実行時にレート制限エラーが頻発
- **原因**: インプットトークン数が多すぎる（1PRあたり約8000トークン）
- **影響**: 分析速度の大幅な低下、複数セッションに分割が必要

### 2. 非効率な処理方式
- **現状**: 1PR = 1APIリクエスト = 1メッセージ消費
- **問題**: 749件で749メッセージを消費（制限の83%）
- **結果**: 1セッション内で完了不可能

### 3. トークン使用量
- **PR本文**: 最大3000文字
- **diff**: 最大3000文字
- **冗長な情報**: 作成者、日付、リアクション数など
- **合計**: 1PRあたり約8000トークン

## 📊 Claude API仕様（Max Plan $200）

### セッション制限
- **メッセージ数**: 5時間あたり900メッセージ
- **リセット**: 最初のメッセージから5時間後
- **重要**: 並列数を下げても総使用量は変わらない

### ベストプラクティス（Anthropic公式）
1. **メッセージ効率化**: 複数の質問を1メッセージにまとめる
2. **Projects活用**: ドキュメントをキャッシュして再利用
3. **コンテキスト活用**: 会話内で情報を参照し再送信を避ける

## 🚀 改善計画

### 1. バッチ処理の実装
```python
# 現在: 1PR = 1メッセージ
analyze_pr(pr1)  # 1メッセージ
analyze_pr(pr2)  # 1メッセージ

# 改善後: 10PR = 1メッセージ
analyze_batch([pr1, pr2, ..., pr10])  # 1メッセージで10件処理
```

**効果**: メッセージ消費を1/10に削減（749→75メッセージ）

### 2. トークン削減
```python
# 現在の設定
ANALYSIS_CONFIG = {
    'prompt_body_limit': 3000,  # 多すぎる
    'prompt_diff_limit': 3000,   # 多すぎる
}

# 改善後
ANALYSIS_CONFIG = {
    'prompt_body_limit': 500,    # 83%削減
    'prompt_diff_limit': 300,     # 90%削減
}
```

**効果**: 1PRあたり8000→1500トークン（81%削減）

### 3. 並列処理の最適化
```python
# エラーハンドリング付き並列実行
class SmartAnalyzer:
    def __init__(self):
        self.workers = 20  # 最大並列数
        
    def handle_rate_limit(self):
        # 429エラー時は指数バックオフ
        wait_time = 2 ** retry_count
        time.sleep(wait_time)
```

### 4. プロンプト最適化
```python
# 冗長な指示を削除
# Before: 500文字の詳細な指示
# After: 100文字の簡潔な指示

# JSONテンプレートを短縮
# Before: 完全なJSON構造を提示
# After: 最小限のキー名のみ
```

## 📈 期待される効果

### 技術的改善
| 指標 | 現在 | 改善後 | 改善率 |
|------|------|--------|--------|
| メッセージ消費 | 749 | 75 | 90%削減 |
| トークン/PR | 8000 | 1500 | 81%削減 |
| 処理時間 | 2-3時間 | 30分 | 80%短縮 |
| セッション数 | 2-3 | 1 | 完結型 |

### スケール対応への影響
| 処理対象 | 現在の処理時間 | 改善後の処理時間 | 実用性 |
|----------|----------------|------------------|--------|
| 教育749件 | 2-3時間 | 30分 | ✅ 実用的 |
| 医療1000件 | 3-4時間 | 40分 | ✅ 実用的 |
| 全6000件 | 18-24時間 | 4-5時間 | ✅ 1日で完了 |
| 月次増分（約5000件） | 15-20時間 | 3-4時間 | ✅ 定期処理可能 |

### ボトルネック解消への貢献
- **現在**: 手動レビュー待ち6000件蓄積
- **改善後**: 自動分析による事前仕分け→人手は最終判断のみ
- **期待効果**: 処理効率10-20倍向上、蓄積問題の根本解決

## 🛠 実装予定機能

### 1. batch_analyzer.py
```python
# バッチ処理専用スクリプト
- 10件単位でPRをグループ化
- 結果を個別JSONに分割保存
- エラー時の部分的リトライ
```

### 2. token_optimizer.py
```python
# トークン使用量の事前計算
- プロンプト生成前にトークン数を推定
- 制限を超える場合は自動で短縮
- 統計情報の出力
```

### 3. session_manager.py
```python
# セッション管理
- 使用量のリアルタイムトラッキング
- 制限到達前の警告
- 自動的な処理の一時停止と再開
```

## 📝 次回実行時のチェックリスト

- [ ] バッチ処理の実装（10PR/メッセージ）
- [ ] トークン削減版プロンプトの使用
- [ ] 並列数を20-30に設定
- [ ] エラーハンドリングの実装
- [ ] 進捗の可視化ツール
- [ ] セッション使用量のモニタリング

## 🎯 結論

### 技術的課題
現在の1PR=1メッセージ方式は非効率的。バッチ処理とトークン削減により、**1セッション内で全PR分析が可能**になる。

### 政治的・社会的緊急性
- **6000件の蓄積**: 政策提案への応答遅延が民主的プロセスに影響
- **日次処理率2%**: 現状では永続的な問題解決不可能
- **有権者への影響**: 提案が埋もれることで市民参加の意義が失われる

### 解決の優先度
1. **即座に実装**: バッチ処理システム（処理能力10倍向上）
2. **段階的展開**: 教育→医療→経済→全分野へ
3. **自動化**: 類似提案の統合、重複検出、優先度付け

### 期待される成果
- **処理時間**: 全6000件を1日で分析可能
- **政策品質**: 類似提案の統合により重複を削減
- **民主的プロセス**: 迅速な応答により市民参加を促進
- **コスト効率**: 人手作業を10-20倍効率化

この改善により、**政党としての政策対応能力を根本的に向上**できる。