# 2025年7月9日 PR分析・ラベル更新作業の記録と教訓

## 作業概要
- 対象: READMEラベル付きPR 383件 → 政策分野ラベルへの付け替え
- 結果: 325件成功（58件は新規PRで分析対象外）
- 作業時間: 約1時間

## 遭遇した問題と解決策

### 1. 大量バッチ処理でのタイムアウト
**問題**: 50件のバッチ処理で2分後にタイムアウト
```bash
# これは失敗した
python3 update_pr_labels_batch.py 50 50
```

**解決策**: 
- バッチサイズを20件に縮小
- それでもタイムアウトする場合は1件ずつ処理

### 2. バックグラウンド処理の出力が見えない
**問題**: `nohup` で実行したがログファイルが空
```bash
nohup python3 update_remaining_prs.py > update_log.txt 2>&1 &
# update_log.txt が0バイト
```

**解決策**: Pythonの出力バッファリングを無効化
```python
import sys
print("メッセージ")
sys.stdout.flush()  # 即座に出力
```

### 3. ghコマンドの連続実行エラー
**問題**: 連続してghコマンドを実行すると失敗

**解決策**: 各コマンド間に適切な間隔を設定
```python
time.sleep(0.5)  # 最低0.5秒の間隔
```

## 最終的に成功したアプローチ

```python
# update_with_logging.py の主要部分
for i, pr in enumerate(remaining_prs):
    # 1つのコマンドでラベル削除と追加を同時実行
    cmd = [
        "gh", "pr", "edit", pr_num, 
        "--repo", "team-mirai/policy",
        "--remove-label", "README",
        "--add-label", new_label
    ]
    
    # 実行
    result = subprocess.run(cmd, capture_output=True, text=True)
    
    # 適切な間隔
    time.sleep(0.5)
    
    # 即座にログ出力
    sys.stdout.flush()
```

## 重要な学び

### 1. ユーザーの要求を正確に理解
- 「LLMを使って分析」という明確な指示があった
- キーワードベースの分析は明確に拒否された

### 2. GitHub APIの制限を考慮
- 大量の連続リクエストは避ける
- 適切な間隔（0.5秒以上）を設定
- 1コマンドで複数の操作を実行（効率化）

### 3. 進捗の可視化
- リアルタイムでの進捗表示が重要
- Pythonのバッファリングに注意
- ログファイルへの即時書き込み

### 4. エラーハンドリング
- 新規PR（分析結果なし）のスキップ処理
- エラー時も処理を継続
- 成功率の計算と表示

## 次回への推奨事項

1. **開始前の確認**
   ```bash
   python3 check_label_status.py
   ```

2. **効率的な実行方法**
   ```bash
   python3 update_with_logging.py
   ```

3. **モニタリング**
   - 別ターミナルで `tail -f update_detailed.log`
   - 定期的に `check_label_status.py` で進捗確認

4. **時間の見積もり**
   - 1件あたり0.5秒 + 処理時間
   - 300件なら約5-10分

## コマンドまとめ
```bash
# 状況確認
python3 check_label_status.py

# PR情報取得
python3 get_readme_prs.py

# 分析（要LLM）
python3 complete_all_analysis.py

# ラベル更新
python3 update_with_logging.py
```